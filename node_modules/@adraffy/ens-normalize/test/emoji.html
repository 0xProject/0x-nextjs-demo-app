<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Emoji</title>
<style>
.hide {
	display: none !important;
}
button {
	cursor: pointer;
}
@keyframes spin {
	from { transform:rotate(0deg); }
	to	 { transform:rotate(360deg); }
}
body { 
	margin: 3rem; 
	background: #eee;
}
h1 {
	margin: 0;
}
#links {
	display: flex;
	flex-wrap: wrap;
	gap: 0.2rem 0.5rem;
}
#search {
	margin: 1rem 0;
	display: flex;
	align-items: stretch;
}
#search input {
	display: block;
	padding: 5px;
	font-size: 150%;
	width: 100%;
	box-sizing: border-box;
}
#search select {
	margin-left: 0.5rem;
	max-width: 50px;
	-webkit-appearance: menulist-button;
}
#hover {
	position: absolute;
	font-size: 200px;
	background: rgba(255, 255, 255, .85);
	padding: 20px;
	border: 10px solid rgba(128, 128, 128, .2);
	border-radius: 40px;
	left: 50%;
	min-width: 300px;
	text-align: center;
}
.heading {
	display: flex;
	align-items: center;
}
h2 {
	flex: 1 0 auto;
}
h2 span {
	color: #800;
}
.right a {
	text-decoration: none;
}
.right button {
	font-size: 16pt;
	margin-left: 0.5rem;
}
table {
	border-collapse: collapse;
	width: 100%;
	text-align: left;
}
tbody tr:nth-child(odd) {
	background: #fff;
}
tbody tr:hover {
	background-color: #cff;
}
tbody tr.error td {
	background: rgba(255, 0, 0, 0.1);
}
td {
	border: 1px solid #ccc;
	padding: 0 10px;
}
*[data-copy] {
	cursor: pointer;
}
.arrow {
	color: #888;
}
.index {
	text-align: center;
}
.form {
	text-align: center;
}
td.form {
	font-size: 200%;
}
.form a {
	text-decoration: none;
	color: #000;
}
td.index {
	color: #999;
}
td.info {
	padding: 5px 10px;
	width: 100%;
}
.cells {
	display: flex;
	flex-wrap: wrap;
	align-items: center;
	gap: 5px;
}
.cells .name0 {
	color: #666;
}
.cells .version {
	color: #999;
	font-size: 90%;
}
.cells code {
	background: #ffa;
	font-size: 120%;
	padding: 2px 4px;
}
.cells code.mapped {
	background: #fff;
}
.exploded {
	display: flex;
	flex-wrap: wrap;
	align-items: center;
	gap: 5px;
}
.norm {
	background: #fca;
	padding: 2px 5px;
	border-radius: 5px;
	min-width: 1rem;
}
#loading {
	display: flex;
	justify-content: center;
}
#loading > div { 
	display: flex;
	background: #ffc;
	border-radius: 0.5rem;
	padding: 1rem 2rem;
	font-size: 20pt;
	border: 1px solid #ccc;
	gap: 1rem;
	align-items: center;
}
#loading .arrows {
	width: 2rem;
	height: 2rem;
	animation: spin 2s infinite linear;
	user-select: none;
	background-image: url('data:image/svg+xml;utf8,%3Csvg%20viewBox%3D%220%200%201000%201000%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M990%2C377.5H622.5l137.4-137.4C690.4%2C170.7%2C598.2%2C132.5%2C500%2C132.5c-98.2%2C0-190.4%2C38.2-259.9%2C107.6C170.7%2C309.6%2C132.5%2C401.8%2C132.5%2C500c0%2C98.2%2C38.2%2C190.4%2C107.6%2C259.9c69.4%2C69.4%2C161.7%2C107.6%2C259.9%2C107.6c98.2%2C0%2C190.4-38.2%2C259.9-107.6c5.8-5.8%2C11.4-11.8%2C16.7-17.9l92.2%2C80.7C778.9%2C925.2%2C647%2C990%2C500%2C990C229.4%2C990%2C10%2C770.6%2C10%2C500C10%2C229.4%2C229.4%2C10%2C500%2C10c135.3%2C0%2C257.8%2C54.9%2C346.5%2C143.5L990%2C10V377.5z%22%2F%3E%3C%2Fsvg%3E');
	background-size: contain;
	background-repeat: no-repeat;
}
footer {
	text-align: center;
	color: #666;
	margin: 1rem;
}
@media only screen and (max-width: 800px) { 
	body {
		margin: 0;
	}
	h1 {
		font-size: 20pt;
	}
	header {
		margin: 1rem;
		display: flex;
		flex-wrap: wrap;
		justify-content: space-between;
	}
	#version {
		order: 2;
	}
	#links {
		order: 3;
		flex-basis: 100%;
	}
	#search {
		margin: 0 1rem;
	}
	.heading {
		padding: 0.5rem 1rem;
		background: #ddd;
		margin-bottom: 0.5rem;
	}
	.heading h2 {
		margin: 0;
		font-size: 16pt;
	}
}
</style>
</head>
<body>
<header>
<h1>Emoji</h1>
<div id="links">
<a href="./resolver.html"><b>Resolver</b></a>
<a href="https://raffy.antistupid.com/eth/ens-emoji-freq.html">Emoji Frequency</a>
<a href="https://github.com/adraffy/ens-normalize.js">@adraffy/ens-normalize.js</a>
‚Ä¢
<a href="https://www.unicode.org/reports/tr51/">UTS-51</a>
<a href="https://unicode.org/emoji/charts/full-emoji-list.html">Unicode List</a>
<a href="https://unicode.org/emoji/charts/full-emoji-modifiers.html">Modifiers</a>
<a href="https://unicode.org/emoji/charts/emoji-counts.html">Counts</a>
<a href="https://unicode.org/emoji/charts/emoji-released.html">Recently Added</a>
<a href="https://unicode.org/emoji/charts/emoji-proposals.html">Proposals</a>
</div>
</header>
<div id="search">
	<input placeholder="Search: Name or {FFF} or v15 or UnicodeProperty">
	<select class="hide" placeholder="A">
		<option selected disabled hidden>üîçÔ∏è</option>
	</select>
</div>
<ul id="toc"></ul>
<div id="hover" class="hide"></div>
<main>
	<div id="loading"><div>
		<div class="arrows"></div>
		<span>Downloading...</span>
	</div></div>
</main>
<section id="results" class="hide"></section>
<footer>Created by <a href="https://twitter.com/adraffy">raffy.eth</a></footer>
<script type="module">
import {
	ens_normalize, ens_beautify, ens_tokenize, ens_emoji,
	hex_cp, explode_cp, compare_arrays,
	dom_from_tokens, use_default_style
} from '../dist/all.min.js';
use_default_style();

const search_field = document.querySelector('#search input');
const search_select = document.querySelector('#search select');
const toc_ul = document.querySelector('#toc');
const main = document.querySelector('main');
const results_section = document.querySelector('#results');
const hover_div = document.querySelector('#hover');

let last_hover;
let search_timer;
let emoji_seqs = ens_emoji();
let emoji_disabled = [];
let info_map = new Map();
let type_map = new Map();
let versions = new Set();
let flat = [];
let buckets = [];

// holy fucking safari without top-level await...
(async () => {
	try {
		for (let info of await fetch_json('../derive/output/emoji-info.json')) {
			info_map.set(info.form, info);
			if (is_not_emoji(info)) {
				emoji_disabled.push(explode_cp(info.form));
			}
		}
	} catch (err) {
		console.log(err);
	}

	for (let x of info_map.values()) {
		type_map.set(x.type.toLowerCase(), x.type);
		versions.add(parseInt(x.version)|0);
		let {name, name0} = x;
		if (name0) {
			name0 = name0.toLowerCase(); 
			if (name0 === name) {
				delete x.name0;
			} else {
				x.name0 = name0;
			}
		}
		x.query = searchize(name0 ? `${name} ${name0}` : name);
	}

	let keywords = [
		[...type_map.values()].sort(), 
		[
			'Man ',
			'Woman',
			'Gender: Man|{2640}',
			'Gender: Woman|{2642}',
			'Family',
			'Person',
			`Golden|=\\b(wo)?man\\b,\\bperson\\b!{1F3FB},{1F3FC},{1F3FD},{1F3FE},{1F3FF},^flag`,
			'Light Skin',
			'Medium-light Skin',
			'Medium Skin',
			'Medium-dark Skin',
			'Dark Skin',
			'Red Hair',
			'Blond Hair',
			'Curly Hair',
			'White Hair',
			'Is Normalized|is-norm',
			'Already Normalized|already-norm',
			'Requires Normalization|gets-normed',
			'Unmod(1)',
			'{FE0F}',
		],
		[...versions].sort((a, b) => a - b).map(x => `v${x}`),
	].flat(Infinity);

	if (type_map.size || versions.size) {
		search_select.append(...keywords.map(s => {
			let op = document.createElement('option');
			let pos = s.indexOf('|');
			if (pos >= 0) {
				op.value = s.slice(pos + 1).trim();
				s = s.slice(0, pos).trim();
			}
			op.innerHTML = s;
			return op;
		}));
		search_select.classList.remove('hide');
	}

	for (let cps of emoji_seqs) {
		let rec = make_rec(cps);
		let n = [...rec.norm].length;
		rec.n = n;
		let bucket = buckets[n];
		if (!bucket) buckets[n] = bucket = [];
		bucket.push(rec);
		flat.push(rec);
	}
	document.querySelector('h1').innerHTML += ` (${flat.length})`; // + ${emoji_disabled.length})`;

	for (let cps of emoji_disabled) {
		flat.push(make_rec(cps));
	}

	process_hash();

	window.addEventListener('hashchange', process_hash);

	search_field.addEventListener('input', search_soon);

	// hide on intersection
	hover_div.addEventListener('mousemove', e => {
		hover_div.classList.add('hide');
	});

	// hide on exit	
	window.addEventListener('mouseout', () => {
		hover_div.classList.add('hide');
	});

	search_select.addEventListener('input', () => {
		search_field.value = search_select.value;
		update_search();
	});


	document.addEventListener('mousemove', e => {
		let {target} = e;
		if (!(target instanceof Element)) return;
		let tr = target.closest('[data-name]');
		hover_div.classList.toggle('hide', !tr);
		if (!tr) return;
		let {name} = tr.dataset;
		if (name == last_hover) return;
		last_hover = name;
		let r = tr.getBoundingClientRect();
		let y = r.top + window.scrollY;
		let gap = 0.5;
		if (r.top < window.innerHeight * .5) {		
			y += r.height * (1 + gap);
			hover_div.style.transform = 'translate(-50%, 0)';
		} else {
			y -= r.height * gap;
			hover_div.style.transform = 'translate(-50%, -100%)';
		}
		hover_div.style.top = `${y}px`;
		hover_div.innerHTML = name;
	});

	document.body.addEventListener('pointerdown', e => {
		let node = e.target.closest(`[data-copy]`);
		if (!node) return;
		let {copy, alt} = node.dataset;
		if (alt && e.altKey) copy = alt;
		if (copy) {
			navigator.clipboard.writeText(copy);
		}
	});

})();

function make_rec(cps) {
	let form = String.fromCodePoint(...cps);
	let norm;
	let is_norm;
	try {
		norm = ens_normalize(form);
		is_norm = true;
	} catch (err) {
		norm = form;
	}
	let info = info_map.get(form);	
	let rec = {form, norm, cps, info, is_norm};
	rec.tr = create_tr(rec, `${[...norm].length}<sub>ch</sub>`);
	return rec;
}

function process_hash(e) {
	let hash = window.location.hash.slice(1);
	let sel;
	if (hash) {
		let match;
		if (match = hash.match(/^q\=(.*)$/)) {
			search_field.value = decodeURIComponent(match[1]);
			search_field.select();
		} else if (/^\d+$/.test(hash)) {
			search_field.value = '';
			sel = `[name="${hash}"]`;
		}
	}
	update_search();
	if (sel) {
		let el = document.querySelector(sel);
		if (el) requestAnimationFrame(() => el.scrollIntoView());
	}
}

function search_soon() {
	if (search_timer) return;
	search_timer = setTimeout(update_search, 100);
}

function update_search() {
	clearTimeout(search_timer);
	search_timer = undefined;
	search_select.selectedIndex = 0;
	let input = searchize(search_field.value);
	search_field.focus();
	toc_ul.classList.toggle('hide', input);
	main.classList.toggle('hide', input);
	results_section.classList.toggle('hide', !input);
	const prefix = '#q=';
	if (!input) {
		if (window.location.hash.startsWith(prefix)) {
			window.history.replaceState(null, null, ' ');
		}
		if (main.querySelector('#loading')) {
			main.innerHTML = '';
			for (let n = 1; n < buckets.length; n++) {
				let bucket = buckets[n];
				if (!bucket) continue;
				let title =`${n} character${n==1?'':'s'} (${bucket.length})`;
				let li = document.createElement('li');
				li.innerHTML = `<a href="#${n}">${title}</a>`;
				toc_ul.append(li);

				let h2 = document.createElement('h2');
				h2.innerHTML = `<a name="${n}">${title}</a>`;

				let a_jump = document.createElement('a');
				a_jump.classList.add('right');
				a_jump.innerHTML = 'Top ‚¨Ü';
				a_jump.href = '#';
				a_jump.addEventListener('click', e => {
					e.preventDefault();
					window.history.replaceState(null, null, ' ');
					window.scrollTo(0, 0);
				});

				let heading_div = document.createElement('div');
				heading_div.classList.add('heading');
				heading_div.append(h2, a_jump);

				let section = document.createElement('section');
				section.append(heading_div, create_table(bucket));
				main.append(section);
			}
		}
		return;
	}
	window.history.replaceState(null, null, prefix + input);
	let results;
	let match;
	if (input === 'is-norm') {
		results = flat.filter(x => x.info && !is_not_emoji(x.info));
	} else if (input === 'gets-normed') {
		results = flat.filter(x => x.is_norm && x.form !== x.norm);
	} else if (input === 'already-norm') {
		results = flat.filter(x => x.is_norm && x.form === x.norm);	
	} else if (match = input.match(/^v\d*$/)) {
		let version = parseInt(input.slice(1));
		results = flat.filter(x => x.info && parseInt(x.info.version) == version);
	} else if (match = type_map.get(input)) {
		results = flat.filter(x => x.info && x.info.type === match);
	} else if (match = input.match(/^unmod\((\d+)\)$/i)) {
		let max = parseInt(match[1]);
		let ignored = new Set([
			127995,127996,127997,127998,127999, // skin
			//129456,129457,129458,129459, // hair
			0x2640, 0x2642, // gender
			0xFE0F,
		]);
		let dups = new Map();
		for (let rec of flat) {
			if (!(rec.n >= 3)) continue;
			let key = String.fromCodePoint(...rec.cps.filter(cp => !ignored.has(cp)));
			let bucket = dups.get(key);
			if (!bucket) {
				bucket = [];
				dups.set(key, bucket);
			}
			bucket.push(rec);
		}
		results = [...dups.values()].filter(v => v.length <= max).flat();
	} else if (input.startsWith('=')) {
		input = replace_escapes(input.slice(1));
		let pos = input.indexOf('!');
		let none = [];
		function split(s) {
			return s.split(',').map(x => x.trim()).filter(x => x).map(x => {
				try {
					return ens_normalize(x);
				} catch (err) {
				}
				try {
					return new RegExp(x, 'iu');
				} catch (err)  {
				}
				return x;
			});
		}
		if (pos >= 0) {
			none = split(input.slice(pos + 1));
			input = input.slice(0, pos);
		} 
		let any = split(input);
		function check(x, test) {
			if (test instanceof RegExp) {
				return test.test(x.form) || x.info && test.test(x.info.query);
			} else {
				return x.norm.includes(test) || (x.info && x.info.query.includes(test));
			}
		}
		results = flat.filter(x => (any.length == 0 || any.some(test => check(x, test))) && !none.some(test => check(x, test)));
	} else {
		input = replace_escapes(input);
		let norm;
		try {
			norm = ens_normalize(input.trim());
		} catch (err) {			
		}
		results = flat.filter(x => {
			if (x.info && x.info.query.includes(input)) return true; 
			if (norm && x.norm.includes(norm)) return true; 
			if (x.form.includes(input)) return true;
		});
	}
	let valid = results.reduce((a, x) => a + (x.info && is_not_emoji(x.info)?0:1), 0);



	let h2 = document.createElement('h2');
	h2.innerText = `${valid} result${valid==1?'':'s'} (${(100*valid/emoji_seqs.length).toFixed(2)}%)`;
	if (valid < results.length) {
		let span = document.createElement('span');
		span.innerText = ` +${results.length - valid} disabled`;
		h2.append(span);
	}

	let heading_div = document.createElement('div');
	heading_div.classList.add('heading');	
	heading_div.append(h2);

	if (results.length) {
		let csv_btn = document.createElement('button');
		csv_btn.innerText = 'CSV';
		csv_btn.addEventListener('click', () => {
			let rows = results.map(x => {
				let v = [x.form, x.cps.map(hex_cp).join(' '), x.norm, [...x.norm].length];
				if (x.info) {
					v.push(x.info.name, x.info.type, x.info.version);
				}
				return v.map(x => typeof x === 'number' ? x : `"${x}"`).join(',');
			});
			let a = document.createElement('a');
			a.download = 'Emoji.csv';
			a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent([`Form,Hex,Norm,Length,Name,Type,Version`, ...rows].join('\n'));
			a.click();
		});

		let repeated_btn = document.createElement('button');
		repeated_btn.innerText = 'Copy Min Repeated';
		repeated_btn.addEventListener('click', () => navigator.clipboard.writeText(results.map(x => repeated(x.norm)).join('\n')));

		let right_div = document.createElement('div');
		right_div.classList.add('right');
		right_div.append(repeated_btn, csv_btn);
		heading_div.append(right_div);
	}
	results_section.innerHTML = '';
	results_section.append(heading_div, create_table(results, true));
	hover_div.classList.add('hide');
}

function create_table(bucket, search) {
	let table = document.createElement('table');
	table.innerHTML = `
		<table>
		<thead>
		<tr>
		<th class="index">${search ? 'n<sub>ch</sub>' : '#'}</th>
		<th class="form">üíñÔ∏è</th>
		<th class="info">Name, Version, Codepoints (Fully-Qualified), Components &rarr; Normalized</th>
		</tr>
		</thead>
		<tbody></tbody>
		</table>
	`;
	table.querySelector('tbody').append(...bucket.map((x, i) => search ? x.tr : create_tr(x, 1+i)));
	return table;
}

function create_hex_code(name, cps) {
	let hex = cps.map(hex_cp).join(' ');
	let code = document.createElement('code');
	code.title = `${name}\n(Click to Copy)`;
	code.dataset.copy = hex;
	code.innerText = hex;
	return code;
}

function create_tr({cps, form, norm, info}, first) {
	let tr = document.createElement('tr');

	let td_index = document.createElement('td');
	td_index.classList.add('index');
	td_index.innerHTML = first;
	td_index.title = `Fully-Qualified Form\n(Click to Copy)`;
	td_index.dataset.copy = form;
	if (form.includes('\uFE0F') && !form.includes('\u200D')) {
		td_index.dataset.alt = form.replaceAll('\uFE0F', '\uFE0E');
		td_index.title += `\n[ALT] Text-styled Form`;
	}

	let td_form = document.createElement('td');
	td_form.classList.add('form');
	let a_resolve = document.createElement('a');
	a_resolve.href = `./resolver.html#${repeated(norm)}.eth`;
	a_resolve.innerHTML = form;
	a_resolve.title = 'Resolve in Demo\n(Minimal Repeated)';
	td_form.append(a_resolve);

	let td_cells = document.createElement('td');
	td_cells.classList.add('info');
	
	let cells_div = document.createElement('div');
	cells_div.classList.add('cells');
	if (info) {
		let {name, name0, version, type} = info;
		let a_name = document.createElement('a');
		a_name.innerText = name;
		a_name.href = `https://emojipedia.org/${form}`;
		cells_div.append(a_name);
		if (name0) {
			let span = document.createElement('i');
			span.classList.add('name0');
			span.innerText = name0;
			cells_div.append(span);
		}
		if (version) {
			let span = document.createElement('span');
			span.classList.add('version');
			span.innerText = `v${version}`;
			cells_div.append(span);
		}
		//if (type === 'Whitelisted') tr.classList.add('whitelisted');
		if (is_not_emoji(info)) tr.classList.add('error');
	}	
	cells_div.append(create_hex_code('Fully-Qualified', cps));
	
	let tokens = ens_tokenize(form);

	let exploded_div = document.createElement('div');
	exploded_div.classList.add('exploded');
	exploded_div.append(dom_from_tokens(tokens, {components: true, before: true, emoji_url: false}));
	cells_div.append(exploded_div);
	if (form !== norm) {
		let span_arrow = document.createElement('span');
		span_arrow.innerText = '‚ûî';
		span_arrow.classList.add('arrow');

		let span_norm = document.createElement('span');
		span_norm.classList.add('norm')
		span_norm.innerText = norm;
		span_norm.dataset.copy = norm;
		span_norm.title = 'Normalized Form\n(Click to Copy)';

		exploded_div.append(span_arrow, span_norm);
		
		if (tokens.some(t => t.type === 'mapped')) {
			let span = create_hex_code('Normalized (Mapped)', explode_cp(norm));
			span.classList.add('mapped');
			cells_div.append(span);
		}
	}	

	td_cells.append(cells_div);

	tr.dataset.name = form;
	tr.append(td_index, td_form, td_cells);
	return tr;
}

function repeated(norm, n = 3) {
	return norm.repeat(1 + Math.max(0, n - [...norm].length));
}

async function fetch_json(url) {
	let res = await fetch(url);
	if (res.status !== 200) throw new Error(`HTTP Error ${res.status}`);
	return res.json();
}

function is_not_emoji(x) {
	return x.type === 'Disabled'; // matches /derive/make.js -> emoji-info.json
}

function searchize(s) {
	return s.toLowerCase()
		.replace(/^\s+/, '') // leading whitespace
		.replaceAll(/\s+/gu, ' '); // repeated whitespace
}

function replace_escapes(s) {
	return s.replaceAll(/\{([0-9a-f]+)\}/gui, (_, x) => {
		try {
			return String.fromCodePoint(parseInt(x, 16));
		} catch (err) {
			return x;
		}
	});
}
</script>
</body>
</html>