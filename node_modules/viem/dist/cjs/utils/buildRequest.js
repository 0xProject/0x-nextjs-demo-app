"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildRequest = exports.isDeterministicError = void 0;
const base_js_1 = require("../errors/base.js");
const request_js_1 = require("../errors/request.js");
const rpc_js_1 = require("../errors/rpc.js");
const withRetry_js_1 = require("./promise/withRetry.js");
const isDeterministicError = (error) => {
    if ('code' in error)
        return (error.code !== -1 &&
            error.code !== -32004 &&
            error.code !== -32005 &&
            error.code !== -32042 &&
            error.code !== -32603);
    if (error instanceof request_js_1.HttpRequestError && error.status)
        return (error.status !== 403 &&
            error.status !== 408 &&
            error.status !== 413 &&
            error.status !== 429 &&
            error.status !== 500 &&
            error.status !== 502 &&
            error.status !== 503 &&
            error.status !== 504);
    return false;
};
exports.isDeterministicError = isDeterministicError;
function buildRequest(request, { retryDelay = 150, retryCount = 3, } = {}) {
    return (async (args) => (0, withRetry_js_1.withRetry)(async () => {
        try {
            return await request(args);
        }
        catch (err_) {
            const err = err_;
            if (err.code === -32700)
                throw new rpc_js_1.ParseRpcError(err);
            if (err.code === -32600)
                throw new rpc_js_1.InvalidRequestRpcError(err);
            if (err.code === -32601)
                throw new rpc_js_1.MethodNotFoundRpcError(err);
            if (err.code === -32602)
                throw new rpc_js_1.InvalidParamsRpcError(err);
            if (err.code === -32603)
                throw new rpc_js_1.InternalRpcError(err);
            if (err.code === -32000)
                throw new rpc_js_1.InvalidInputRpcError(err);
            if (err.code === -32001)
                throw new rpc_js_1.ResourceNotFoundRpcError(err);
            if (err.code === -32002)
                throw new rpc_js_1.ResourceUnavailableRpcError(err);
            if (err.code === -32003)
                throw new rpc_js_1.TransactionRejectedRpcError(err);
            if (err.code === -32004)
                throw new rpc_js_1.MethodNotSupportedRpcError(err);
            if (err.code === -32005)
                throw new rpc_js_1.LimitExceededRpcError(err);
            if (err.code === -32006)
                throw new rpc_js_1.JsonRpcVersionUnsupportedError(err);
            if (err.code === -32042)
                throw new rpc_js_1.MethodNotSupportedRpcError(err);
            if (err.code === 4001)
                throw new rpc_js_1.UserRejectedRequestError(err);
            if (err.code === 4100)
                throw new rpc_js_1.UnauthorizedProviderError(err);
            if (err.code === 4200)
                throw new rpc_js_1.UnsupportedProviderMethodError(err);
            if (err.code === 4900)
                throw new rpc_js_1.ProviderDisconnectedError(err);
            if (err.code === 4901)
                throw new rpc_js_1.ChainDisconnectedError(err);
            if (err.code === 4902)
                throw new rpc_js_1.SwitchChainError(err);
            if (err_ instanceof base_js_1.BaseError)
                throw err_;
            throw new rpc_js_1.UnknownRpcError(err);
        }
    }, {
        delay: ({ count, error }) => {
            if (error && error instanceof request_js_1.HttpRequestError) {
                const retryAfter = error?.headers?.get('Retry-After');
                if (retryAfter?.match(/\d/))
                    return parseInt(retryAfter) * 1000;
            }
            return ~~(1 << count) * retryDelay;
        },
        retryCount,
        shouldRetry: ({ error }) => !(0, exports.isDeterministicError)(error),
    }));
}
exports.buildRequest = buildRequest;
//# sourceMappingURL=buildRequest.js.map